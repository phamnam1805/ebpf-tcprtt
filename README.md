# eBPF TCP RTT Monitor

This repository is an adaptation of the [eunomia-bpf tcpstates example](https://github.com/eunomia-bpf/bpf-developer-tutorial/blob/main/src/14-tcpstates/README.md), for the TCP RTT part. The userspace is implemented in Go using the [cilium/ebpf](https://github.com/cilium/ebpf) library instead of the original C userspace.

## Overview

This project measures per-connection TCP RTT using an eBPF fentry attached to `tcp_rcv_established`. It samples kernel `srtt_us` from `struct tcp_sock`, converts the kernel fixed-point representation, and aggregates samples into log2 histograms stored in a BPF map.

Collected/visible data includes:
- Per-key histogram of RTT values (groupable by local or remote IPv4 address)
- Optional extended stats: total latency and sample count (for average computations)
- Filters for source/destination ports and IPv4 addresses
- Option to present RTT in milliseconds

## Key Differences from Original

- **Userspace Language**: Go instead of C
- **BPF Library**: [cilium/ebpf](https://github.com/cilium/ebpf) instead of libbpf
- **Attach Type**: fentry on `tcp_rcv_established` (collects samples on receive path)
- **Code Generation**: Uses `bpf2go` for generating Go bindings from eBPF C code
- **Modern API**: Leverages Go's type safety and error handling

## Architecture

```
ebpf-tcprtt/
├── bpf/
│   ├── tcprtt.bpf.c       # eBPF kernel program (C) — fentry on tcp_rcv_established
│   ├── tcprtt.h           # shared definitions (struct hist, constants)
│   └── vmlinux.h          # CO-RE kernel types (generated)
├── cmd/
│   └── main.go            # CLI entrypoint (parses flags and starts probe)
├── internal/
│   └── probe/
│       ├── probe.go       # eBPF loader, rodata setup, attach, map reading
│       ├── probe_bpfeb.go # generated by bpf2go (BE)
│       └── probe_bpfel.go # generated by bpf2go (LE)
├── Makefile               # helpers to build BPF and Go binary
└── README.md
```

## Requirements

- Linux kernel 5.8+ with BTF support (for CO-RE / fentry)
- Go 1.21+
- `clang` and `llvm` for compiling eBPF programs
- Root (or CAP_BPF) to load eBPF programs

## Installation

```bash
# Clone the repository
git clone https://github.com/phamnam1805/ebpf-tcprtt.git
cd ebpf-tcprtt

# Install dependencies
go mod download

# Build: the Makefile compiles the eBPF C code and builds the Go binary
make build
```

If your environment doesn't use the Makefile, generate Go bindings from the C sources with `bpf2go` and compile the Go program.

## Usage

Run the probe (needs root):

```bash
sudo ./ebpf-tcprtt \
	-laddr-hist \
	-ms
```

Flags supported by `cmd/main.go`:
- `-laddr-hist` : group histogram by local IPv4 address (boolean)
- `-raddr-hist` : group histogram by remote IPv4 address (boolean)
- `-show-ext`   : collect extended stats (sum latency and sample count)
- `-sport`      : source port filter (integer)
- `-dport`      : destination port filter (integer)
- `-saddr`      : source IPv4 dotted string (e.g. 192.168.1.1)
- `-daddr`      : destination IPv4 dotted string
- `-ms`         : report srtt in milliseconds (default behavior is kernel fixed-point handling -> microseconds shifted)

Note: rodata variables that control behavior (like `targ_laddr_hist`, `targ_raddr_hist`, `targ_show_ext`, `targ_ms`, `targ_sport`, `targ_dport`, `targ_saddr`, `targ_daddr`) are set before loading the BPF object; they cannot be changed at runtime.

## Output Format

This program periodically (every 10s) reads the `hists` BPF map and prints entries. Example printed output:

```
Key: 127.0.0.1
Latency = 180
Cnt = 11

     (unit)              : count    distribution
         0 -> 0          : 0        |                                        |
         1 -> 1          : 0        |                                        |
         2 -> 3          : 0        |                                        |
         4 -> 7          : 4        |**********************                  |
         8 -> 15         : 7        |****************************************|
```

Fields meaning:
- `key`: grouping key (0 means global histogram; non-zero is IPv4 address when grouping per address)
- `cnt`: number of samples (only present if `--show-ext` is enabled)
- `latency`: cumulative latency units (only present if `--show-ext` is enabled; units depend on `--ms` flag)
- `slots`: histogram buckets (log2 buckets). Index `i` holds count for bucket `i`.

## How It Works

### Kernel-Side (eBPF)

- An fentry program is attached to `tcp_rcv_established`.
- For each relevant receive event it:
	- Reads `srtt_us` from `struct tcp_sock` using CO-RE-safe `BPF_CORE_READ`.
	- Converts the fixed-point representation (shift right by 3) to get the SRTT in microseconds.
	- Optionally divides by 1000 when `targ_ms` is set to report milliseconds.
	- Computes a `log2` bucket index and updates the per-key histogram in the `hists` map using atomic adds.
	- If `targ_show_ext` is set, it atomically accumulates the latency and increments the sample count.

### User-Space (Go)

1. Parse CLI flags and convert dotted IPv4 strings to uint32 network-order values.
2. Set rodata variables in the loaded eBPF object (so the BPF program knows filter settings).
3. Attach the eBPF fentry and start a goroutine that periodically (1s) iterates the `hists` map and prints the contents.
4. On shutdown, detach and close BPF objects cleanly.

## Troubleshooting

- "Failed to load BPF object": run with root or ensure CAP_BPF, and ensure clang/llvm are installed.
- "No output": generate TCP traffic (curl), or loosen filters; ensure the binary is running as root and BTF is present at `/sys/kernel/btf/vmlinux`.
- Map layout mismatch: If you change `struct hist` in `bpf/tcprtt.h`, regenerate bindings and user-space decoding logic.

## Use Cases

- Network debugging: inspect per-connection RTT distributions.
- Performance analysis: measure smoothed RTT trends across servers/clients.
- Application monitoring: focus on services by filtering ports or addresses.

## References

- [eunomia-bpf tcpstates tutorial](https://github.com/eunomia-bpf/bpf-developer-tutorial/blob/main/src/14-tcpstates/README.md)
- [cilium/ebpf](https://github.com/cilium/ebpf)
- [eBPF documentation](https://ebpf.io/)

## License

MIT
